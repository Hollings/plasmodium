#!/bin/bash
# Plasmodium - self-orchestrating agent network
# The slime mold finds the path

set -e

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
export PM_SCRIPT_DIR="$SCRIPT_DIR"
source "$SCRIPT_DIR/lib/core.sh"

case "${1:-}" in
    # Signal commands
    signal)
        shift
        pm_signal "$@"
        ;;
    signals)
        shift
        pm_signals "$@"
        ;;

    # Phase commands
    explore)
        shift
        pm_explore "$@"
        ;;
    execute)
        shift
        pm_execute "$@"
        ;;
    fruit)
        shift
        pm_fruit "$@"
        ;;

    # Work commands
    new)
        shift
        pm_new "$@"
        ;;
    claim)
        shift
        pm_claim "$@"
        ;;
    split)
        shift
        pm_split "$@"
        ;;
    ripen)
        shift
        pm_ripen "$@"
        ;;

    # Plan & approval commands
    plan)
        shift
        pm_plan "$@"
        ;;
    approve)
        shift
        pm_approve "$@"
        ;;
    reject)
        shift
        pm_reject "$@"
        ;;

    # Worker commands
    spawn)
        shift
        pm_spawn "$@"
        ;;
    status)
        shift
        pm_status "$@"
        ;;

    # Setup commands
    init)
        shift
        pm_init "$@"
        ;;
    dashboard)
        shift
        pm_dashboard "$@"
        ;;

    *)
        echo "plasmodium - self-orchestrating agent network"
        echo ""
        echo "Usage: pm <command> [args...]"
        echo ""
        echo "Setup:"
        echo "  init [path]         Initialize plasmodium in a project"
        echo "  dashboard [port]    Start the dashboard (default: 3456)"
        echo ""
        echo "Work:"
        echo "  new [--depends id] <task>  Create new spore (auto-spawns worker)"
        echo "  claim <id>                 Claim a spore"
        echo "  split <id> <tasks...>      Split spore into sub-spores"
        echo ""
        echo "Plan & Approval:"
        echo "  plan <id> [--approvals N]  Submit plan for review"
        echo "  approve <id> [reason]      Approve a plan"
        echo "  reject <id> <reason>       Reject a plan"
        echo ""
        echo "Phases:"
        echo "  explore <id>        Enter plasmodium mode (exploration)"
        echo "  execute <id>        Enter mycelium mode (execution)"
        echo "  fruit <id> <output> Complete work with output"
        echo ""
        echo "Signals:"
        echo "  signal <msg>        Emit to signal log"
        echo "  signals [--follow]  Read signal log"
        echo ""
        echo "Workers:"
        echo "  spawn [name]        Start new worker (usually auto)"
        echo "  status              Show colony status"
        exit 1
        ;;
esac
