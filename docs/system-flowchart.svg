<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 900 700">
  <defs>
    <marker id="arrowhead" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
      <polygon points="0 0, 10 3.5, 0 7" fill="#58a6ff"/>
    </marker>
    <filter id="shadow" x="-20%" y="-20%" width="140%" height="140%">
      <feDropShadow dx="2" dy="2" stdDeviation="3" flood-opacity="0.3"/>
    </filter>
  </defs>

  <style>
    .box { fill: #161b22; stroke: #30363d; stroke-width: 2; filter: url(#shadow); }
    .box-start { fill: #238636; stroke: #2ea043; }
    .box-end { fill: #238636; stroke: #2ea043; }
    .box-owner { fill: #8957e5; stroke: #a371f7; }
    .box-phase { fill: #1f6feb; stroke: #58a6ff; }
    .box-agent { fill: #9e6a03; stroke: #d29922; }
    .text { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; fill: #c9d1d9; font-size: 14px; text-anchor: middle; }
    .text-small { font-size: 11px; fill: #8b949e; }
    .text-bold { font-weight: 600; fill: #f0f6fc; }
    .arrow { stroke: #58a6ff; stroke-width: 2; fill: none; marker-end: url(#arrowhead); }
    .arrow-owner { stroke: #a371f7; }
    .label { font-size: 11px; fill: #8b949e; }
  </style>

  <!-- Background -->
  <rect width="900" height="700" fill="#0d1117"/>

  <!-- Title -->
  <text x="450" y="35" class="text text-bold" font-size="20">Plasmodium System Flow</text>
  <text x="450" y="55" class="text text-small">Task lifecycle from creation to completion</text>

  <!-- USER: pm task -->
  <rect x="350" y="80" width="200" height="50" rx="25" class="box box-start"/>
  <text x="450" y="105" class="text text-bold">pm task "..."</text>
  <text x="450" y="120" class="text text-small">User creates task</text>

  <path d="M450 130 L450 170" class="arrow"/>

  <!-- Owner Spawned -->
  <rect x="350" y="170" width="200" height="50" rx="8" class="box box-owner"/>
  <text x="450" y="195" class="text text-bold">Owner Agent Spawns</text>
  <text x="450" y="210" class="text text-small">Reads task, plans phases</text>

  <path d="M450 220 L450 270" class="arrow arrow-owner"/>

  <!-- Phase Loop Container -->
  <rect x="100" y="260" width="700" height="320" rx="12" fill="none" stroke="#30363d" stroke-width="1" stroke-dasharray="5,5"/>
  <text x="130" y="285" class="text text-small">Phase Loop</text>

  <!-- Create Phase -->
  <rect x="350" y="300" width="200" height="60" rx="8" class="box box-owner"/>
  <text x="450" y="325" class="text text-bold">Create Phase</text>
  <text x="450" y="342" class="text text-small">Name, perspectives,</text>
  <text x="450" y="355" class="text text-small">message limit</text>

  <path d="M450 360 L450 400" class="arrow arrow-owner"/>

  <!-- Spawn Agents -->
  <rect x="350" y="400" width="200" height="50" rx="8" class="box box-owner"/>
  <text x="450" y="425" class="text text-bold">Spawn Phase Agents</text>
  <text x="450" y="440" class="text text-small">One per perspective</text>

  <!-- Arrows to agents -->
  <path d="M350 425 L250 425 L250 470" class="arrow"/>
  <path d="M550 425 L650 425 L650 470" class="arrow"/>

  <!-- Agent 1 -->
  <rect x="170" y="470" width="160" height="50" rx="8" class="box box-agent"/>
  <text x="250" y="495" class="text text-bold">Agent A</text>
  <text x="250" y="510" class="text text-small">perspective 1</text>

  <!-- Agent 2 -->
  <rect x="570" y="470" width="160" height="50" rx="8" class="box box-agent"/>
  <text x="650" y="495" class="text text-bold">Agent B</text>
  <text x="650" y="510" class="text text-small">perspective 2</text>

  <!-- Phase box -->
  <rect x="320" y="470" width="260" height="70" rx="8" class="box box-phase"/>
  <text x="450" y="495" class="text text-bold">Phase Discussion</text>
  <text x="450" y="512" class="text text-small">pm chat / pm say / pm work</text>
  <text x="450" y="527" class="text text-small">Until message limit + work done</text>

  <!-- Arrows from agents to phase -->
  <path d="M330 495 L320 495" class="arrow" style="marker-end: none"/>
  <path d="M580 495 L570 495" class="arrow" style="marker-end: none"/>

  <!-- Phase closes -->
  <path d="M450 540 L450 560" class="arrow"/>
  <text x="450" y="555" class="text text-small">[closed]</text>

  <!-- More phases? -->
  <polygon points="450,565 530,605 450,645 370,605" fill="#161b22" stroke="#30363d" stroke-width="2"/>
  <text x="450" y="600" class="text text-small" fill="#f0f6fc">More</text>
  <text x="450" y="615" class="text text-small" fill="#f0f6fc">phases?</text>

  <!-- Yes - loop back -->
  <path d="M370 605 L150 605 L150 330 L350 330" class="arrow arrow-owner"/>
  <text x="200" y="595" class="label">Yes</text>

  <!-- No - task done -->
  <path d="M530 605 L620 605" class="arrow"/>
  <text x="555" y="595" class="label">No</text>

  <!-- Task Complete -->
  <rect x="620" y="580" width="150" height="50" rx="25" class="box box-end"/>
  <text x="695" y="605" class="text text-bold">Task Complete</text>
  <text x="695" y="620" class="text text-small">Owner exits</text>

  <!-- Legend -->
  <rect x="720" y="80" width="160" height="130" fill="#161b22" stroke="#30363d" rx="8"/>
  <text x="800" y="105" class="text text-bold" font-size="12">Legend</text>

  <rect x="735" y="120" width="20" height="15" rx="4" class="box box-owner"/>
  <text x="765" y="132" class="text text-small" text-anchor="start">Owner actions</text>

  <rect x="735" y="145" width="20" height="15" rx="4" class="box box-phase"/>
  <text x="765" y="157" class="text text-small" text-anchor="start">Phase</text>

  <rect x="735" y="170" width="20" height="15" rx="4" class="box box-agent"/>
  <text x="765" y="182" class="text text-small" text-anchor="start">Phase agents</text>
</svg>
